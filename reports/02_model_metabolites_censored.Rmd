---
title: "Fit models censored"
author: "Matthew Shane Loop, PhD"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
```

Here we will fit the Bayesian regression models, treating values below the limit of detection as censored. The decisions made and details of the analysis can be found in the `docs/statistical_analysis_plan.Rmd` document.

Let's bring in the data and do slight manipulation:
```{r}
library(tidyverse)
library(brms)

water <- read_tsv("../data/water_cleaned.txt") %>% mutate_if(is.character, ~na_if(., "")) %>%
  mutate(time_pretty = as.character(time_pretty)) %>%
  group_by(metabolite) %>%
  mutate(non_missing = if_else(is.na(value) == FALSE, 1, 0),
         total_non_missing = sum(non_missing)) %>%
  filter(total_non_missing > 50) %>%
  mutate(value = if_else(is.na(value), lloq, value),
    log_value = log(value),
         censored = if_else(value == lloq, "left",
                      if_else(value > uloq, "right", "none"))
  )
```

Here are all of the compounds we will model:
```{r}
water %>%
  distinct(metabolite) %>%
  kable()
```


## Amphetamine
```{r}
water %>%
  filter(metabolite == "Amphetamine") %>%
  count(censored)
```



Now let's start designing the code. We will sample from the priors only to start with.
```{r}
options(mc.cores = parallel::detectCores())
prior_amphetamine <- c(prior(normal(0, 1), class = "Intercept"),  # These priors were chosen from iteratively doing prior predictive checks
           prior(cauchy(0, 0.5), class = "sd"),
           prior(cauchy(0, 0.5), class = "sigma"),
           prior(normal(0, 1), class = "b"))

fit_amphetamine_priors <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Amphetamine"),
           iter = 2000,
           chains = 1, 
           sample_prior = "only",
           prior = prior_amphetamine)
```

Prior predictive checks:
```{r}
pp_check(fit_amphetamine_priors)
```

Whoa! Looks like way to much variability.

```{r}
ppd <- posterior_predict(fit_amphetamine_priors)

ggplot(filter(water, metabolite == "Amphetamine"), aes(x = log_value)) + geom_histogram(bins = 500) 
hist(ppd[1, ])
hist(ppd[2, ])
hist(ppd[3, ])
```

Alright, let's fit the model for real now.
```{r}
fit_amphetamine <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Amphetamine"),
           iter = 6000,
           chains = 4, 
           prior = prior_amphetamine)
save(fit_amphetamine, file = "02_model_metabolites_censored_amphetamine.RData")
```

```{r}
summary(fit_amphetamine)
```

Posterior predictive checks of distribution
```{r}
pp_check(fit_amphetamine)
```
```{r}
a <- posterior_predict(fit_amphetamine)
sd(a[1, ])
sd(a[2, ])
sd(a[1000, ])
water %>% filter(metabolite == "Amphetamine") %>% summarise(standard = sd(log_value))
```

The distribution is a little wider, but maybe it's OK.

```{r}
a <- posterior_predict(fit_amphetamine, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high))
```

Summary of expected concentration at each time point
```{r, fig.width=7, fig.height=2}
b <- posterior_linpred(fit_amphetamine, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

cowplot::plot_grid(b %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.025),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.975)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Mean concentration (median, 95% credible interval)",
    x = "Time of day",
    y = "Mean concentration (ng/mL)"
  ),
  a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Predicted distribution of concentrations (median, 50% prediction interval)",
    x = "Time of day",
    y = "Predicted concentration (ng/mL)"
  ))
```

## Benzoylcgonine
```{r}
water %>%
  filter(metabolite == "Benzoylecgonine") %>%
  count(censored)
```

Now let's start designing the code. We will sample from the priors only to start with.
```{r}
prior_benzo <- c(prior(normal(0, 1), class = "Intercept"),  # These priors were chosen from iteratively doing prior predictive checks
           prior(cauchy(0, 0.5), class = "sd"),
           prior(cauchy(0, 0.5), class = "sigma"),
           prior(normal(0, 1), class = "b"))

fit_benzo_priors <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Benzoylecgonine"),
           iter = 2000,
           chains = 1, 
           sample_prior = "only",
           prior = prior_benzo)
```

Prior predictive checks:
```{r}
pp_check(fit_benzo_priors)
```

```{r}
ppd <- posterior_predict(fit_amphetamine_priors)

ggplot(filter(water, metabolite == "Benzoylecgonine"), aes(x = log_value)) + geom_histogram(bins = 500) 
hist(ppd[1, ])
hist(ppd[2, ])
hist(ppd[3, ])
```

Alright, let's fit the model for real now.
```{r}
fit_benzo <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Benzoylecgonine"),
           iter = 6000,
           chains = 4, 
           prior = prior_benzo)
save(fit_benzo, file = "02_model_metabolites_censored_benzoylecgonine.RData")
```

```{r}
summary(fit_benzo)
```

Posterior predictive checks of distribution
```{r}
pp_check(fit_benzo)
```

The distribution is a little wider, but maybe it's OK.

```{r}
a <- posterior_predict(fit_benzo, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high))
```

Summary of expected concentration at each time point
```{r, fig.width=7, fig.height=2}
b <- posterior_linpred(fit_benzo, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

cowplot::plot_grid(b %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.025),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.975)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Mean concentration (median, 95% credible interval)",
    x = "Time of day",
    y = "Mean concentration (ng/mL)"
  ),
  a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Predicted distribution of concentrations (median, 50% prediction interval)",
    x = "Time of day",
    y = "Predicted concentration (ng/mL)"
  ))
```

## Cocaine
```{r}
water %>%
  filter(metabolite == "Cocaine") %>%
  count(censored)
```

Now let's start designing the code. We will sample from the priors only to start with.
```{r}
prior_cocaine <- c(prior(normal(0, 1), class = "Intercept"),  # These priors were chosen from iteratively doing prior predictive checks
           prior(cauchy(0, 0.5), class = "sd"),
           prior(cauchy(0, 0.5), class = "sigma"),
           prior(normal(0, 1), class = "b"))

fit_cocaine_priors <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Cocaine"),
           iter = 2000,
           chains = 1, 
           sample_prior = "only",
           prior = prior_cocaine)
```

Prior predictive checks:
```{r}
pp_check(fit_cocaine_priors)
```

Alright, let's fit the model for real now.
```{r}
fit_cocaine <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Cocaine"),
           iter = 6000,
           chains = 4, 
           prior = prior_cocaine)
save(fit_cocaine, file = "02_model_metabolites_censored_cocaine.RData")
```

```{r}
summary(fit_cocaine)
```

Posterior predictive checks of distribution
```{r}
pp_check(fit_cocaine)
```

The distribution is a little wider, but maybe it's OK.

```{r}
a <- posterior_predict(fit_cocaine, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high))
```

Summary of expected concentration at each time point
```{r, fig.width=7, fig.height=2}
b <- posterior_linpred(fit_cocaine, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

cowplot::plot_grid(b %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.025),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.975)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Mean concentration (median, 95% credible interval)",
    x = "Time of day",
    y = "Mean concentration (ng/mL)"
  ),
  a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Predicted distribution of concentrations (median, 50% prediction interval)",
    x = "Time of day",
    y = "Predicted concentration (ng/mL)"
  ))
```

## Hydrocodone
```{r}
water %>%
  filter(metabolite == "Hydrocodone") %>%
  count(censored)
```

Now let's start designing the code. We will sample from the priors only to start with.
```{r}
prior_hydrocodone <- c(prior(normal(0, 1), class = "Intercept"),  # These priors were chosen from iteratively doing prior predictive checks
           prior(cauchy(0, 0.5), class = "sd"),
           prior(cauchy(0, 0.5), class = "sigma"),
           prior(normal(0, 1), class = "b"))

fit_hydrocodone_priors <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Hydrocodone"),
           iter = 2000,
           chains = 1, 
           sample_prior = "only",
           prior = prior_hydrocodone)
```

Prior predictive checks:
```{r}
pp_check(fit_amphetamine_priors)
```

Alright, let's fit the model for real now.
```{r}
fit_hydrocodone <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Hydrocodone"),
           iter = 6000,
           chains = 4, 
           prior = prior_hydrocodone)
save(fit_hydrocodone, file = "02_model_metabolites_censored_hydrocodone.RData")
```

```{r}
summary(fit_hydrocodone)
```

Posterior predictive checks of distribution
```{r}
pp_check(fit_hydrocodone)
```

The distribution is a little wider, but maybe it's OK. It's also down some, but that actually makes sense. We set a lot of the censored values to the lloq, but now we are trying to generate those values.

```{r}
a <- posterior_predict(fit_hydrocodone, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high))
```

Summary of expected concentration at each time point
```{r, fig.width=7, fig.height=2}
b <- posterior_linpred(fit_hydrocodone, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

cowplot::plot_grid(b %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.025),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.975)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Mean concentration (median, 95% credible interval)",
    x = "Time of day",
    y = "Mean concentration (ng/mL)"
  ),
  a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Predicted distribution of concentrations (median, 50% prediction interval)",
    x = "Time of day",
    y = "Predicted concentration (ng/mL)"
  ))
```

## Norhydrocodone
```{r}
water %>%
  filter(metabolite == "Norhydrocodone") %>%
  count(censored)
```

Now let's start designing the code. We will sample from the priors only to start with.
```{r}
prior_norhydrocodone <- c(prior(normal(0, 1), class = "Intercept"),  # These priors were chosen from iteratively doing prior predictive checks
           prior(cauchy(0, 0.5), class = "sd"),
           prior(cauchy(0, 0.5), class = "sigma"),
           prior(normal(0, 1), class = "b"))

fit_norhydrocodone_priors <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Norhydrocodone"),
           iter = 2000,
           chains = 1, 
           sample_prior = "only",
           prior = prior_norhydrocodone)
```

Prior predictive checks:
```{r}
pp_check(fit_norhydrocodone_priors)
```

Alright, let's fit the model for real now.
```{r}
fit_norhydrocodone <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Norhydrocodone"),
           iter = 6000,
           chains = 4, 
           prior = prior_norhydrocodone)
save(fit_norhydrocodone, file = "02_model_metabolites_censored_norhydrocodone.RData")
```

```{r}
summary(fit_norhydrocodone)
```

Posterior predictive checks of distribution
```{r}
pp_check(fit_norhydrocodone)
```

```{r}
a <- posterior_predict(fit_norhydrocodone, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high))
```

Summary of expected concentration at each time point
```{r, fig.width=7, fig.height=2}
b <- posterior_linpred(fit_norhydrocodone, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

cowplot::plot_grid(b %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.025),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.975)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Mean concentration (median, 95% credible interval)",
    x = "Time of day",
    y = "Mean concentration (ng/mL)"
  ),
  a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Predicted distribution of concentrations (median, 50% prediction interval)",
    x = "Time of day",
    y = "Predicted concentration (ng/mL)"
  ))
```

## Noroxycodone
```{r}
water %>%
  filter(metabolite == "Noroxycodone") %>%
  count(censored)
```

Now let's start designing the code. We will sample from the priors only to start with.
```{r}
prior_noroxycodone <- c(prior(normal(0, 0.05), class = "Intercept"),  # These priors were chosen from iteratively doing prior predictive checks
           prior(cauchy(0, 0.25), class = "sd"),
           prior(cauchy(0, 0.25), class = "sigma"),
           prior(normal(0, 0.5), class = "b"))

fit_noroxycodone_priors <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Noroxycodone"),
           iter = 2000,
           chains = 1, 
           sample_prior = "only",
           prior = prior_noroxycodone)
```

Prior predictive checks:
```{r}
pp_check(fit_noroxycodone_priors)
```

```{r}
water %>% filter(metabolite == "Noroxycodone") %>% ggplot(aes(x = value)) + geom_histogram(bins = 200)
```


Alright, let's fit the model for real now.
```{r}
fit_noroxycodone <- brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = filter(water, metabolite == "Noroxycodone"),
           iter = 6000,
           chains = 4, 
           prior = prior_noroxycodone)
save(fit_noroxycodone, file = "02_model_metabolites_censored_noroxycodone.RData")
```

Noroxycodone is a pain in the ass.


```{r}
summary(fit_hydrocodone)
```

Posterior predictive checks of distribution
```{r}
pp_check(fit_hydrocodone)
```

The distribution is a little wider, but maybe it's OK. It's also down some, but that actually makes sense. We set a lot of the censored values to the lloq, but now we are trying to generate those values.

```{r}
a <- posterior_predict(fit_hydrocodone, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high))
```

Summary of expected concentration at each time point
```{r, fig.width=7, fig.height=2}
b <- posterior_linpred(fit_hydrocodone, newdata = water %>% ungroup() %>% distinct(time_pretty), re_formula = NA) %>%
  t() %>% 
  as_tibble() %>% 
  bind_cols(water %>% ungroup() %>% distinct(time_pretty), .) %>% 
  gather(iteration, predicted_concentration, -time_pretty) %>% 
  mutate(predicted_exp = exp(predicted_concentration)) %>% 
  ungroup()

cowplot::plot_grid(b %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.025),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.975)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Mean concentration (median, 95% credible interval)",
    x = "Time of day",
    y = "Mean concentration (ng/mL)"
  ),
  a %>%
  group_by(time_pretty) %>%
  summarise(low = quantile(predicted_exp, 0.25),
            median = quantile(predicted_exp, 0.5),
            high = quantile(predicted_exp, 0.75)) %>% 
  ggplot(aes(x = time_pretty, y = median)) +
  geom_pointrange(aes(ymin = low, ymax = high)) +
  labs(
    title = "Predicted distribution of concentrations (median, 50% prediction interval)",
    x = "Time of day",
    y = "Predicted concentration (ng/mL)"
  ))
```


# Fit everything

Now that we've worked out what we want to look at and good priors, let's fit the same model to the 10 most common metabolites.

```{r}
prior <- c(prior(normal(0, 5), class = "Intercept"),
           prior(cauchy(0, 1), class = "sd"),
           prior(cauchy(0, 1), class = "sigma"))

model_fits <- water %>%
  nest() %>%
  mutate(
    fit = map(data, ~brm(log_value | cens(censored) ~ time_pretty + (1 | machine) + (1 | extraction) + (1 | location),
           family = gaussian(),
           data = .,
           iter = 4000,
           chains = 5, 
           prior = prior))
  )
save(model_fits, file = "02_model_metabolites_censored.RData")
```

Posterior predictive checks
```{r}
model_fits$fit[[8]]
cowplot::plot_grid(plotlist = map(model_fits$fit, ~pp_check(., replace = TRUE)))
```

```{r}
model_fits %>%
  mutate(
    draws = map(fit, ~as.data.frame(.) %>% tibble())
  )
```

