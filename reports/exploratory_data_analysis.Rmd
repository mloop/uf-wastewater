---
output: 
  tufte::tufte_html
title: "Exploratory data analysis"
author: "Matthew Shane Loop, PhD"
---

```{r, include = FALSE}
knitr::opts_chunk$set(message = FALSE, echo=FALSE)
library(skimr)
library(tidyverse)
library(haven)
library(Hmisc)

water <- read_tsv("../data/water_cleaned.txt") %>% mutate_if(is.character, funs(na_if(., "")))

#water_gameday = filter(water, date == "2018-09-08")  # How do we find the gameday measurements now? Is it just gameday measurements in there are the moment?

water_gameday = water
```

```{r}
describe(water_gameday) %>%
  html()
```

```{r, fig.height=5, fig.width=3, fig.cap="Any cells that are blank have only 1 data point. The counts for morphine and trazodone dominate everything else, but maybe those are a lot of 'cutoff' values. ", warning = FALSE}
water_gameday %>%
  ggplot(aes(x = value_simulated)) +
  geom_density() +
  facet_grid(metabolite_name ~ location) +
  ggthemes::theme_tufte() +
  theme(
    strip.text.y = element_text(angle = 360)
  )
```

```{r, fig.height=12, fig.width=7, fig.cap="Any cells that are blank have only 1 data point. Concentrations equal to the cutoff value or values that are out of range have been removed.", warning = FALSE}
water_gameday %>%
  filter(is.na(value) == FALSE) %>%
  ggplot(aes(x = log(value))) +
  geom_density() +
  facet_grid(metabolite_name ~ location, scales = "free_y") +
  ggthemes::theme_tufte() +
  theme(
    strip.text.y = element_text(angle = 360)
  )
```
How many of the concentrations are simulated, by compound?
```{r}
water_gameday %>%
  group_by(metabolite_name) %>%
  mutate(below_cutoff = if_else(is.na(value) ==  TRUE, 1, 0)) %>%
  summarise(
    number_below_cutoff = sum(below_cutoff),
    total_measurements = n()
  ) %>%
  mutate(proportion_below_cutoff = number_below_cutoff / total_measurements) %>%
  arrange(desc(proportion_below_cutoff)) %>%
  kable()
```

# Simulate values of concentration for observations below the limit of detection

How many measurements are there per site?
```{r}
water_gameday %>% count(location, metabolite_name) %>% group_by(location) %>% slice(1) %>% select(location, n) %>% kable()
```

We have a concentration for each of the compounds we were interested in for each of these samples taken.

```{r, fig.height=12, fig.width=7, }
water_gameday %>%
  ggplot(aes(x = time_pretty, y = value_simulated)) +
  geom_point() +
  geom_smooth() +
  facet_grid(metabolite_name ~ location, scales = "free_y")
```


Let's fit models for each compound individually with the simulated values:
```{r, fig.height=10, fig.width=5}
library(arm)
library(broom)
library(Hmisc)
library(cowplot)
library(modelr)
library(rms)


fit <- water_gameday %>%
  mutate(location = factor(location)) %>%
  group_by(location) %>%
  mutate(time_from_0_minutes = (timestamp - min(timestamp)) / 60) %>%
  ungroup() %>%
  group_by(metabolite_name) %>%
  filter(metabolite_name %in% c("Pseudoephedrine", "THCA", "Amphetamine", "Benzoylecgonine", "Noroxycodone")) %>%
  nest() %>%
  mutate(
    model = map(data, ~lm(value_simulated ~ location + rcs(time_from_0_minutes, 3), data = .)),
    simulated_coefficients = map(model, ~sim(., n.sims = 100)),
    prediction_grid = map(data, ~data_grid(., time_from_0_minutes = seq_range(time_from_0_minutes, 20), location)),
    #simulated_predictions = map2(simulated_coefficients, prediction_grid, ~for(s in 1:nrow(.x)){
     # .x[s, ] %*% .y 
    #}),
    predictions = map2(model, prediction_grid, ~predict(.x, newdata = .y, se = TRUE) %>% as_tibble() %>%  bind_cols(.y, .)),
    #broom_predictions = map(model, ~augment(.)),
    fitted_lines = map(predictions, ~ggplot(data = ., aes(x = time_from_0_minutes, y = fit, color = factor(location))) +
                                      geom_path() +
                         geom_ribbon(aes(ymin = fit - 2 * se.fit, ymax = fit + 2 * se.fit, fill = factor(location)), alpha = 0.2) + labs(x = "Time (minutes)", y = "Concentration (ng/mL)") + theme(text = element_text(size = 8)) + scale_color_discrete(name = "Location") + scale_fill_discrete(name = "Location"))#,
    #r_p_plots = map(broom_predictions, ~ggplot(data = ., aes(x = .fitted, y = .resid, color = factor(location))) +
                                      #geom_point() + geom_smooth())
  )

```

Fitted lines:
```{r, fig.width=15, fig.asp=0.8}
plot_grid(plotlist = fit$fitted_lines, labels = fit$metabolite_name, label_x = 0.1) -> p

p

ggplot2::ggsave("fitted_lines.png", p, width = 10, height = 6, units = "in")
```

r/p plots:
```{r, fig.width=15, fig.asp=0.8}
plot_grid(plotlist = fit$r_p_plots, labels = fit$compound)
```

## Mixed model for each compound

start with THCA:
```{r}
thca <- water_gameday %>%
  mutate(location = factor(location)) %>%
  group_by(location) %>%
  mutate(time_from_0_minutes = (timestamp - min(timestamp)) / 60) %>%
  ungroup() %>%
  group_by(metabolite_name) %>%
  filter(metabolite_name %in% c("THCA"))

thca
```

```{r}
library(brms)
fit <- brm(value_simulated ~ (1 + time_from_0_minutes | location) + (1 | run) + time_from_0_minutes,
           data = thca)

summary(fit)

a = ranef(fit)
a
str(a)
```

