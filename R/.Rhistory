library(Hmisc)
library(tidyverse)
library(GGally)
library(brms)
library(cowplot)
water <- read_tsv("../data/water_cleaned.txt") %>% mutate_if(is.character, funs(na_if(., ""))) %>%
mutate(time_pretty = as.character(time_pretty),
extraction = factor(extraction) %>% fct_recode("A" = "zach", "B" = "austin")) %>%
group_by(metabolite) %>%
mutate(non_missing = if_else(is.na(value) == FALSE, 1, 0),
total_non_missing = sum(non_missing)) %>%
mutate(censored_value = if_else(is.na(value) == TRUE, lloq,
if_else(value < lloq, lloq,
if_else(value > uloq, uloq, value)
)
),
log_value = log(censored_value),
censored = if_else(censored_value == lloq, "left",
if_else(censored_value == uloq, "right", "none"))
)
water_analysis <- water %>%
mutate(time_pretty = as.character(time_pretty)) %>%
group_by(metabolite) %>%
mutate(non_missing = if_else(is.na(value) == FALSE, 1, 0),
total_non_missing = sum(non_missing)) %>%
filter(total_non_missing > 50) %>%
mutate(censored_value = if_else(is.na(value) == TRUE, lloq,
if_else(value < lloq, lloq,
if_else(value > uloq, uloq, value)
)
),
log_value = log(censored_value),
censored = if_else(censored_value == lloq, "left",
if_else(censored_value == uloq, "right", "none"))
)
## What drugs were tested for?
water %>%
distinct(metabolite)
setwd("/Users/xinsongdu/mnt/projects/uf-wastewater/R")
water <- read_tsv("../data/water_cleaned.txt") %>% mutate_if(is.character, funs(na_if(., ""))) %>%
mutate(time_pretty = as.character(time_pretty),
extraction = factor(extraction) %>% fct_recode("A" = "zach", "B" = "austin")) %>%
group_by(metabolite) %>%
mutate(non_missing = if_else(is.na(value) == FALSE, 1, 0),
total_non_missing = sum(non_missing)) %>%
mutate(censored_value = if_else(is.na(value) == TRUE, lloq,
if_else(value < lloq, lloq,
if_else(value > uloq, uloq, value)
)
),
log_value = log(censored_value),
censored = if_else(censored_value == lloq, "left",
if_else(censored_value == uloq, "right", "none"))
)
water_analysis <- water %>%
mutate(time_pretty = as.character(time_pretty)) %>%
group_by(metabolite) %>%
mutate(non_missing = if_else(is.na(value) == FALSE, 1, 0),
total_non_missing = sum(non_missing)) %>%
filter(total_non_missing > 50) %>%
mutate(censored_value = if_else(is.na(value) == TRUE, lloq,
if_else(value < lloq, lloq,
if_else(value > uloq, uloq, value)
)
),
log_value = log(censored_value),
censored = if_else(censored_value == lloq, "left",
if_else(censored_value == uloq, "right", "none"))
)
## What drugs were tested for?
water %>%
distinct(metabolite)
## Drugs with no observed values?
water %>%
mutate(prop_nonmissing = total_non_missing / n()) %>%
filter(prop_nonmissing < 0.5, total_non_missing > 0) %>%
distinct(metabolite) %>%
nrow()
## Drugs with at least 1 observed value
water %>%
filter(total_non_missing > 0) %>%
distinct(metabolite) %>%
nrow()
## Drugs observed in less than 50% of samples?
water %>%
filter(total_non_missing == 0) %>%
distinct(metabolite) %>%
nrow()
## Drugs detected in every sample?
water %>%
filter(total_non_missing == 98) %>%
distinct(metabolite) %>%
nrow()
metabolite
water$metabolite
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
install.packages("visdat")
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
ggsave(filename = "../figs/01_missing_data_pattern_xd.png", p)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_bw(axis.text.x.top = element_text(angle = 90)) -> p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_light(axis.text.x.top = element_text(angle = 90)) -> p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90), panel.grid.major.y = element_line(colour = "black")) -> p
ggsave(filename = "../figs/01_missing_data_pattern_xd.png", p)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90), panel.grid.major.x = element_line(colour = "black")) -> p
ggsave(filename = "../figs/01_missing_data_pattern_xd.png", p)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90), panel.grid.major.x = element_line(colour = "black"),
panel.background = element_rect(fill = "white", colour = "grey50")) -> p
ggsave(filename = "../figs/01_missing_data_pattern_xd.png", p)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90), panel.grid.major.x = element_line(colour = "black"),
panel.background = element_rect(fill = "red", colour = "grey50")) -> p
ggsave(filename = "../figs/01_missing_data_pattern_xd.png", p)
ggplot(p)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90), panel.grid.major.x = element_line(colour = "black"),
plot.background = element_rect(fill = "red", colour = "grey50")) -> p
ggsave(filename = "../figs/01_missing_data_pattern_xd.png", p)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90), panel.grid.major.x = element_line(colour = "black"),
strip.background = element_rect(fill = "red", colour = "grey50")) -> p
ggsave(filename = "../figs/01_missing_data_pattern_xd.png", p)
water %>%
ggplot(aes(x = time_pretty, y = value, color = metabolite, linetype = factor(extraction) %>% fct_relevel("A"), group = interaction(extraction, metabolite))) +
geom_path() +
facet_grid(machine ~location) +
scale_linetype(name = "Extraction") +
scale_color_discrete(name = "Metabolite") +
labs(
x = "Time of collection",
y = "Concentration (ng/mL)",
title = "Observed concentration of metabolites with at least 1 nonmissing value, by location and\nmass spectrometer platform"
) +
theme(
legend.position = "bottom",
axis.text.x = element_text(angle = 45, hjust = 1),
text = element_text(size = 16)
) -> p
ggsave(filename = "../figs/01_longitudinal_all_metabolites_xd.png", p)
water_analysis %>%
ggplot(aes(x = censored_value)) +
geom_histogram(bins = 100) +
geom_vline(aes(xintercept = lloq), linetype = "dashed", color = "red") +
geom_vline(aes(xintercept = uloq), linetype = "dashed", color = "red") +
theme_bw() +
facet_wrap(~ metabolite, scales = "free") +
labs(x = "Measured concentration (ng/mL)") -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90), panel.grid.major.x = element_line(colour = "black"),
strip.background = element_rect(fill = "red", colour = "grey50")) -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss()
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90), panel.grid = element_line(colour = "black")) -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90), panel.grid = element_line(colour = "yellow")) -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 45)) -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_bw() -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_light(axis.text.x.top = element_text(angle = 90)) -> p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_light() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
ggsave(filename = "../figs/01_missing_data_pattern_xd.png", p)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_bw() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_classic() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_linedraw() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme(axis.text.x.top = element_text(angle = 90)) +
theme_linedraw() -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_linedraw() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_linedraw() +
par(bg = 'blue') +
theme(axis.text.x.top = element_text(angle = 90)) -> p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_tufte() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_excel() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_dark() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
p
water %>%
ggplot(aes(x = time_pretty, y = value, color = metabolite, linetype = factor(extraction) %>% fct_relevel("A"), group = interaction(extraction, metabolite))) +
geom_path() +
facet_grid(machine ~location) +
scale_linetype(name = "Extraction") +
scale_color_discrete(name = "Metabolite") +
labs(
x = "Time of collection",
y = "Concentration (ng/mL)",
title = "Observed concentration of metabolites with at least 1 nonmissing value, by location and\nmass spectrometer platform"
) +
theme(
legend.position = "bottom",
axis.text.x = element_text(angle = 45, hjust = 1),
text = element_text(size = 16)
) -> p
p
water_analysis
water_analysis %>%
ggplot(aes(x = censored_value)) +
geom_histogram(bins = 100) +
geom_vline(aes(xintercept = lloq), linetype = "dashed", color = "red") +
geom_vline(aes(xintercept = uloq), linetype = "dashed", color = "red") +
theme_bw() +
facet_wrap(~ metabolite, scales = "free") +
labs(x = "Measured concentration (ng/mL)") -> p
p
element_text(angle = 90)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
#  visdat::vis_miss() +
theme_dark() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
water %>%
ggplot(aes(x = time_pretty, y = value, color = metabolite, linetype = factor(extraction) %>% fct_relevel("A"), group = interaction(extraction, metabolite))) +
geom_path() +
facet_grid(machine ~location) +
scale_linetype(name = "Extraction") +
scale_color_discrete(name = "Metabolite") +
labs(
x = "Time of collection",
y = "Concentration (ng/mL)",
title = "Observed concentration of metabolites with at least 1 nonmissing value, by location and\nmass spectrometer platform"
) +
theme(
legend.position = "bottom",
axis.text.x = element_text(angle = 45, hjust = 1),
text = element_text(size = 16)
) -> p
p
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
visdat::vis_miss() +
theme_dark() +
theme(axis.text.x.top = element_text(angle = 90)) -> p
p
library(naniar)
library("naniar")
install.packages("naniar")
library(naniar)
airquality
gg_miss_fct(x = riskfactors, fct = marital)
riskfactors
marital
riskfactors$marital
water
groupby(water, metabolite)
library(dplyr)
groupby(water, metabolite)
waters %>% group_by(water$metabolite)
water %>% group_by(water$metabolite)
water %>% group_by(metabolite)
water %>% group_by(machine)
water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine)
water_test <- water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction)
gg_miss_fct(x = water_test, fct = machine)
water_test
length(water_test)
rep("shimadzu", "waters_1", "waters_2")
rep("shimadzu", "waters_1", "waters_2", times=10)
rep(c("shimadzu", "waters_1", "waters_2"), times=10)
mc = rep(c("shimadzu", "waters_1", "waters_2"), times=length(water_test)/3)
mc
water_test <- water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
mutate(machine = rep(c("shimadzu", "waters_1", "waters_2"), times=length(water_test)/3))
water_test <- water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
mutate(machines = rep(c("shimadzu", "waters_1", "waters_2"), times=length(water_test)/3))
length(water_test)/3)
length(water_test)/3
water_test <- water %>%
select(metabolite, time_pretty, location, extraction, machine, value) %>%
spread(metabolite, value) %>%
select(-time_pretty, -location, -extraction, -machine) %>%
mutate(machines = rep(c("shimadzu", "waters_1", "waters_2"), times=19)
)
rep(c("shimadzu", "waters_1", "waters_2"), times=19)
water_test
water_test$machine <- rep(c("shimadzu", "waters_1", "waters_2"), times=19)
rep(c("shimadzu", "waters_1", "waters_2"), times=19).vector
rep(c("shimadzu", "waters_1", "waters_2"), times=19).vector()
water_test
water_test$machine <- rep(c("shimadzu", "waters_1", "waters_2"), times=19)
water_test$machine <- rep(c("shimadzu", "waters_1", "waters_2"), times=33)
gg_miss_fct(x = water_test, fct = machine)
p <- gg_miss_fct(x = water_test, fct = machine)
p
